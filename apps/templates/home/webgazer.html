<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <!-- bootstrap cdn -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.css" integrity="sha256-Nfu23DiRqsrx/6B6vsI0T9vEVKq1M6KgO8+TV363g3s=" crossorigin="anonymous" />

    <title>Webgazer</title>
</head>

<body>

    <style>
        body{
            background-image: url('/static/assets/img/theme/test.png');
        }
        
        button {
            float: right !important;
            margin: 3px;
        }

    </style>

    <div onclick="saveGaze()" class="ml-auto">
        <button class="btn btn-light">Save</button>
    </div>

    <div onclick="webgazer.resume()">
        <button class="btn btn-light">Resume</button>
    </div>

    <div onclick="webgazer.pause()">
        <button class="btn btn-light">Pause</button>
    </div>

    <div onclick="recordGaze()">
        <button class="btn btn-light">Start</button>
    </div>

    <script>
        // this array will store all the eye movements
        var gaze_points = [];
        var gaze_properties = {};
        let isFirstExecution = true;

        // start recording
        function recordGaze() {
            webgazer.setGazeListener(function (data, elapsedTime) {
                if (data == null) {
                    return;
                }

                if(isFirstExecution){
                    gaze_properties = {
                        "SlideShowStartDateTime": new Date().toISOString(),
                        "TimeZone": Intl.DateTimeFormat().resolvedOptions().timeZone
                    };
                    isFirstExecution = false;
                };
                var coordX = parseFloat(data.x.toFixed(2));
                var coordY = parseFloat(data.y.toFixed(2));
                var timestamp = Date.now();
                //TimeZoneOffset
                // const timezoneOffset = new Date().getTimezoneOffset()
                // const signoTimezoneOffset = timezoneOffset >= 0 ? '-' : '+';
                // const processedTimezoneOffset =  `${signoTimezoneOffset}${Math.abs(timezoneOffset).toString().padStart(2, '0')}`;

                //TimeZoneUTC
                // const diferenciaUTC = new Date().getTimezoneOffset() / 60; // Obtener la diferencia en horas
                // const signoDiferenciaUTC = diferenciaUTC >= 0 ? '-' : '+';
                // const timezone = `UTC${signoDiferenciaUTC}${Math.abs(diferenciaUTC).toString().padStart(2, '0')}:00`

                //Info Zona Horaria
                // const opcionesLocal = { timeZoneName: 'long' };
                // const formatoFechaLocal = new Intl.DateTimeFormat(undefined, opcionesLocal);
                // const infoZonaHorariaLocal = formatoFechaLocal.formatToParts();
                // const localTimeZoneIdentifier = infoZonaHorariaLocal.find(part => part.type === 'timeZoneName').value;

                //Fecha completa actual
                // var fechaActual = new Date();
                // var dia = fechaActual.getDate();
                // var mes = fechaActual.getMonth() + 1; // Los meses comienzan desde 0
                // var año = fechaActual.getFullYear();
                // var hora = fechaActual.getHours();
                // var minuto = fechaActual.getMinutes();
                // var segundo = fechaActual.getSeconds();
                // var milisegundo = fechaActual.getMilliseconds();
                // Formatear en una cadena
                // var LocalFullDate = dia + "/" + mes + "/" + año + " " + hora + ":" + minuto + ":" + segundo + "." + milisegundo;
                // var UTCFullDate = fechaUTC
                
                var fechaUTC = new Date().toISOString();
                var timezoneISO = Intl.DateTimeFormat().resolvedOptions().timeZone;

                var save_url = "http://127.0.0.1:8000/"+"?x="+coordX+";y="+coordY;
                // var temp_image = new Image();

                // temp_image.src= save_url;
                gaze_points.push([coordX, coordY, timestamp ]);
                // console.log(coordX + "," + coordY, + ","+ timestamp+ ","+LocalFullDate+ ","+fechaUTC+ ","+ timezone + ","+processedTimezoneOffset + ","+localTimeZoneIdentifier + ","+timezoneISO);
            }).begin();
        }

        // exporting data to .csv file
        function saveGaze() {
            console.log(gaze_points);

            //Crear zip con .csv y .json
            const zip = new JSZip();
            //Crear csv
            var csv = 'Gaze X,Gaze Y,Timestamp\n';
            gaze_points.forEach(function (row) {
                csv += row.join(',');
                csv += "\n";
            });

            //Crear json
            // var timezone = new Date().getTimezoneOffset();
            
            // var fechaUTC = new Date().toISOString();
            // var timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            // const jsonData = {
            //     "SlideShowStartDateTime": fechaUTC,
            //     "TimeZone": timezone};
            const jsonString = JSON.stringify(gaze_properties);

            //Guardar archivos en zip
            zip.file("webgazer_gazeData.csv", csv);
            zip.file("webgazer_properties.json", jsonString);

            //Descargar zip
            zip.generateAsync({type:"blob"}).then(function(blob) {
                const enlaceDescarga = document.createElement('a');
                enlaceDescarga.href = URL.createObjectURL(blob);
                enlaceDescarga.target = '_blank';
                enlaceDescarga.download = 'gazeData.zip';
                enlaceDescarga.click();
            });

            //Guardar CSV antiguo
            // var hiddenElement = document.createElement('a');
            // hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
            // hiddenElement.target = '_blank';
            // hiddenElement.download = 'gazeData.csv';
            // hiddenElement.click();
        }
    </script>
    
</body>


<script src="/static/assets/js/webgazer/webgazer.js" type="text/javascript">
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>


</html>